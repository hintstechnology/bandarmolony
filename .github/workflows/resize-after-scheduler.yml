name: Resize Container After Scheduler

on:
  # Event-based: triggered via webhook when all scheduler phases complete
  # Only runs after before workflow has completed AND all scheduler phases complete
  repository_dispatch:
    types: [scheduler-completed]
  # Manual trigger
  workflow_dispatch:

env:
  API_URL: ${{ secrets.VITE_API_URL }}
  CONTAINER_APP_NAME: ${{ secrets.BE_CONTAINER_APP_NAME }}
  RESOURCE_GROUP: ${{ secrets.RESOURCE_GROUP }}

jobs:
  resize-after-scheduler:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check Trigger Source
        run: |
          echo "üîç Event Type: ${{ github.event_name }}"
          echo "üîç Workflow: Resize Container After Scheduler"
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "‚úÖ Triggered via webhook (scheduler completed)"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "‚úÖ Triggered manually"
          else
            echo "‚ùå ERROR: Unexpected trigger type: ${{ github.event_name }}"
            exit 1
          fi
      
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Check Scheduler Status
        id: check-status
        run: |
          STATUS=$(curl -s "$API_URL/api/public/scheduler/status")
          ALL_COMPLETED=$(echo $STATUS | jq -r '.data.status.allCompleted // false')
          IS_RUNNING=$(echo $STATUS | jq -r '.data.status.running // false')
          
          echo "all_completed=$ALL_COMPLETED" >> $GITHUB_OUTPUT
          echo "is_running=$IS_RUNNING" >> $GITHUB_OUTPUT
          
          CURRENT_TIME_WIB=$(TZ='Asia/Jakarta' date +"%H:%M")
          echo "üïê Current Time: $CURRENT_TIME_WIB WIB"
          echo "üìä Scheduler Running: $IS_RUNNING"
          echo "‚úÖ All Phases Completed: $ALL_COMPLETED"
      
      - name: Check Current Container Size
        id: check-size
        run: |
          CURRENT_CPU=$(az containerapp show \
            --name $CONTAINER_APP_NAME \
            --resource-group $RESOURCE_GROUP \
            --query "properties.template.containers[0].resources.cpu" \
            -o tsv 2>/dev/null || echo "0.25")
          echo "current_cpu=$CURRENT_CPU" >> $GITHUB_OUTPUT
          
          echo "üíª Current CPU: $CURRENT_CPU"
      
      - name: Check if Resize Needed
        id: should-resize
        run: |
          ALL_COMPLETED="${{ steps.check-status.outputs.all_completed }}"
          IS_RUNNING="${{ steps.check-status.outputs.is_running }}"
          CURRENT_CPU="${{ steps.check-size.outputs.current_cpu }}"
          
          # Only resize if: all phases completed AND container is still large
          # This workflow only runs after before workflow has completed (container is large) 
          # AND all scheduler phases are complete (via webhook)
          
          if [ "$ALL_COMPLETED" = "true" ] && [ "$CURRENT_CPU" != "0.25" ]; then
            echo "resize_needed=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Resize needed: All phases completed and container is large"
          else
            echo "resize_needed=false" >> $GITHUB_OUTPUT
            if [ "$ALL_COMPLETED" != "true" ]; then
              echo "‚è≠Ô∏è Resize not needed: Phases not yet completed (All completed: $ALL_COMPLETED)"
            elif [ "$CURRENT_CPU" = "0.25" ]; then
              echo "‚è≠Ô∏è Resize not needed: Container already small (CPU: $CURRENT_CPU)"
            fi
          fi
      
      - name: Resize Container to Small
        if: steps.should-resize.outputs.resize_needed == 'true'
        run: |
          echo "üîΩ Resizing container to 0.25 vCPU / 0.5GB..."
          az containerapp update \
            --name $CONTAINER_APP_NAME \
            --resource-group $RESOURCE_GROUP \
            --cpu 0.25 \
            --memory 0.5Gi
          
          echo "‚úÖ Container resized successfully to 0.25 vCPU / 0.5GB"

