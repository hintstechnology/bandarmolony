name: Cleanup Frontend Images in Azure Container Registry

on:
  schedule:
    # 09:30 WIB = 02:30 UTC
    - cron: '35 2 * * *'
  workflow_dispatch:

env:
  ACR_NAME: acrbandarmolony
  IMAGE_NAME_FE: bandarmolony-frontend

jobs:
  cleanup-acr:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout (optional)
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Cleanup old frontend images (keep last 3)
      shell: bash
      run: |
        set -euo pipefail

        DRY_RUN=false   # ubah ke true kalau mau test dulu

        echo "Mengambil daftar manifest dari ACR..."
        MANIFESTS=$(az acr repository show-manifests \
          --name "$ACR_NAME" \
          --repository "$IMAGE_NAME_FE" \
          --orderby time_desc \
          --query "[].digest" -o tsv)

        TOTAL=$(echo "$MANIFESTS" | sed '/^$/d' | wc -l)
        echo "Total manifest: $TOTAL"

        if [ "$TOTAL" -le 3 ]; then
          echo "â‰¤ 3 manifest, tidak ada yang dihapus."
          exit 0
        fi

        KEEP=$(echo "$MANIFESTS" | head -n 3)
        DELETE=$(echo "$MANIFESTS" | tail -n +4)

        echo "Dipertahankan (3 terbaru):"
        echo "$KEEP"
        echo
        echo "Akan dihapus ($(echo "$DELETE" | sed '/^$/d' | wc -l)):"
        echo "$DELETE"
        echo

        if [ "$DRY_RUN" = true ]; then
          echo "[DRY RUN] Tidak menghapus apa pun."
          exit 0
        fi

        echo "$DELETE" | while read -r digest; do
          [ -z "$digest" ] && continue
          echo "Menghapus manifest: $digest"
          az acr repository delete \
            --name "$ACR_NAME" \
            --image "${IMAGE_NAME_FE}@${digest}" \
            --yes
        done

        echo "Cleanup selesai. Tersisa 3 manifest terbaru."