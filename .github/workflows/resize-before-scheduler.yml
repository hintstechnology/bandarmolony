name: Resize Container Before Scheduler

on:
  # Real-time: triggered via webhook from backend node-cron (15 minutes before scheduler time)
  # Backend automatically schedules this webhook trigger when:
  # 1. Server starts (auto-start scheduler)
  # 2. Scheduler config is updated
  # 3. Scheduler is restarted
  repository_dispatch:
    types: [scheduler-time-changed]
  # Manual trigger (for testing/debugging)
  workflow_dispatch:

env:
  API_URL: ${{ secrets.VITE_API_URL }}
  CONTAINER_APP_NAME: ${{ secrets.BE_CONTAINER_APP_NAME }}
  RESOURCE_GROUP: ${{ secrets.RESOURCE_GROUP }}

jobs:
  resize-before-scheduler:
    runs-on: ubuntu-latest
    
    steps:
      - name: Get Scheduler Config (Quick Check)
        id: quick-check
        run: |
          echo "üîç Event Type: ${{ github.event_name }}"
          
          # Get current time in UTC and WIB for accurate display
          CURRENT_UTC=$(date -u +"%Y-%m-%d %H:%M:%S")
          CURRENT_WIB=$(TZ='Asia/Jakarta' date +"%Y-%m-%d %H:%M:%S")
          echo "üïê Current UTC Time: $CURRENT_UTC"
          echo "üïê Current WIB Time: $CURRENT_WIB"
          
          # If triggered via webhook from backend, use payload
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "‚úÖ Triggered via repository_dispatch webhook from backend node-cron"
            SCHEDULER_TIME="${{ github.event.client_payload.new_time }}"
            TIMEZONE="${{ github.event.client_payload.timezone }}"
            WEEKEND_SKIP="${{ github.event.client_payload.weekend_skip }}"
            
            # Log payload for debugging
            echo "üìã Webhook Payload:"
            echo "   new_time: $SCHEDULER_TIME"
            echo "   timezone: $TIMEZONE"
            echo "   weekend_skip: $WEEKEND_SKIP"
          else
            # If triggered manually (workflow_dispatch), fetch from API
            echo "üì° Triggered manually (workflow_dispatch) - fetching config from API"
            RESPONSE=$(curl -s "${{ secrets.VITE_API_URL }}/api/public/scheduler/config")
            SCHEDULER_TIME=$(echo $RESPONSE | jq -r '.data.config.PHASE1_DATA_COLLECTION_TIME')
            TIMEZONE=$(echo $RESPONSE | jq -r '.data.config.TIMEZONE')
            WEEKEND_SKIP=$(echo $RESPONSE | jq -r '.data.config.WEEKEND_SKIP')
            
            # Log API response for debugging
            echo "üìã API Config:"
            echo "   PHASE1_DATA_COLLECTION_TIME: $SCHEDULER_TIME"
            echo "   TIMEZONE: $TIMEZONE"
            echo "   WEEKEND_SKIP: $WEEKEND_SKIP"
          fi
          
          # Validate scheduler time
          if [ -z "$SCHEDULER_TIME" ] || [ "$SCHEDULER_TIME" = "null" ]; then
            echo "‚ùå ERROR: Scheduler time is empty or null"
            echo "   SCHEDULER_TIME: '$SCHEDULER_TIME'"
            exit 1
          fi
          
          # Set default timezone if empty
          if [ -z "$TIMEZONE" ] || [ "$TIMEZONE" = "null" ]; then
            TIMEZONE="Asia/Jakarta"
            echo "‚ö†Ô∏è Timezone not provided, using default: $TIMEZONE"
          fi
          
          echo "scheduler_time=$SCHEDULER_TIME" >> $GITHUB_OUTPUT
          echo "timezone=$TIMEZONE" >> $GITHUB_OUTPUT
          echo "weekend_skip=$WEEKEND_SKIP" >> $GITHUB_OUTPUT
          
          echo "‚úÖ Config loaded:"
          echo "   Scheduler Time: $SCHEDULER_TIME $TIMEZONE"
          echo "   Weekend Skip: $WEEKEND_SKIP"
      
      - name: Check Weekend (Quick Skip)
        id: check-weekend-quick
        if: steps.quick-check.outputs.weekend_skip == 'true'
        run: |
          # Check weekend in scheduler timezone (not UTC)
          TIMEZONE="${{ steps.quick-check.outputs.timezone }}"
          # Default to Asia/Jakarta if timezone is empty
          if [ -z "$TIMEZONE" ] || [ "$TIMEZONE" = "null" ]; then
            TIMEZONE="Asia/Jakarta"
          fi
          
          # Get day of week in scheduler timezone
          DAY_OF_WEEK=$(TZ="$TIMEZONE" date +%w)
          if [ "$DAY_OF_WEEK" = "0" ] || [ "$DAY_OF_WEEK" = "6" ]; then
            echo "is_weekend=true" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è Weekend detected ($TIMEZONE) - skipping workflow execution"
          else
            echo "is_weekend=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Calculate Resize Time (Quick Check)
        id: quick-calculate
        if: steps.check-weekend-quick.outputs.is_weekend != 'true'
        run: |
          SCHEDULER_TIME="${{ steps.quick-check.outputs.scheduler_time }}"
          TIMEZONE="${{ steps.quick-check.outputs.timezone }}"
          
          echo "üìê Calculating resize time from scheduler time: $SCHEDULER_TIME $TIMEZONE"
          
          # Use Python for timezone conversion
          PYTHON_OUTPUT=$(python3 << 'EOF'
          from datetime import datetime, timedelta
          import pytz
          import os
          import sys
          
          scheduler_time_str = os.environ.get('SCHEDULER_TIME', '19:00')
          timezone_str = os.environ.get('TIMEZONE', 'Asia/Jakarta')
          
          # Validate scheduler time format
          if not scheduler_time_str or scheduler_time_str == 'null':
              print("ERROR: Scheduler time is empty or null", file=sys.stderr)
              sys.exit(1)
          
          try:
              hour, minute = map(int, scheduler_time_str.split(':'))
          except ValueError:
              print(f"ERROR: Invalid scheduler time format: {scheduler_time_str}", file=sys.stderr)
              sys.exit(1)
          
          tz = pytz.timezone(timezone_str)
          utc = pytz.UTC
          
          # Get current time in scheduler timezone
          now_tz = datetime.now(tz)
          
          # Create scheduler datetime for today in scheduler timezone
          scheduler_dt = tz.localize(datetime(now_tz.year, now_tz.month, now_tz.day, hour, minute))
          
          # If scheduler time has passed today, use tomorrow
          if scheduler_dt <= now_tz:
              scheduler_dt = scheduler_dt + timedelta(days=1)
          
          # Calculate resize time (15 minutes before scheduler)
          resize_dt = scheduler_dt - timedelta(minutes=15)
          
          # Convert to UTC
          resize_utc = resize_dt.astimezone(utc)
          scheduler_utc = scheduler_dt.astimezone(utc)
          
          # Format for comparison
          resize_time_utc = resize_utc.strftime("%H:%M")
          scheduler_time_utc = scheduler_utc.strftime("%H:%M")
          resize_date_utc = resize_utc.strftime("%Y-%m-%d")
          scheduler_date_utc = scheduler_utc.strftime("%Y-%m-%d")
          
          # Also calculate in WIB for display
          resize_wib = resize_dt.strftime("%H:%M")
          scheduler_wib = scheduler_dt.strftime("%H:%M")
          
          print(f"RESIZE_TIME_UTC={resize_time_utc}")
          print(f"SCHEDULER_TIME_UTC={scheduler_time_utc}")
          print(f"RESIZE_DATE_UTC={resize_date_utc}")
          print(f"SCHEDULER_DATE_UTC={scheduler_date_utc}")
          print(f"RESIZE_TIME_WIB={resize_wib}")
          print(f"SCHEDULER_TIME_WIB={scheduler_wib}")
          EOF
          )
          
          # Check for Python errors
          if [ $? -ne 0 ]; then
            echo "‚ùå ERROR: Python script failed"
            echo "$PYTHON_OUTPUT"
            exit 1
          fi
          
          # Extract values from Python output
          RESIZE_TIME_UTC=$(echo "$PYTHON_OUTPUT" | grep "^RESIZE_TIME_UTC=" | head -1 | cut -d'=' -f2 | tr -d '[:space:]')
          SCHEDULER_TIME_UTC=$(echo "$PYTHON_OUTPUT" | grep "^SCHEDULER_TIME_UTC=" | head -1 | cut -d'=' -f2 | tr -d '[:space:]')
          RESIZE_DATE_UTC=$(echo "$PYTHON_OUTPUT" | grep "^RESIZE_DATE_UTC=" | head -1 | cut -d'=' -f2 | tr -d '[:space:]')
          SCHEDULER_DATE_UTC=$(echo "$PYTHON_OUTPUT" | grep "^SCHEDULER_DATE_UTC=" | head -1 | cut -d'=' -f2 | tr -d '[:space:]')
          RESIZE_TIME_WIB=$(echo "$PYTHON_OUTPUT" | grep "^RESIZE_TIME_WIB=" | head -1 | cut -d'=' -f2 | tr -d '[:space:]')
          SCHEDULER_TIME_WIB=$(echo "$PYTHON_OUTPUT" | grep "^SCHEDULER_TIME_WIB=" | head -1 | cut -d'=' -f2 | tr -d '[:space:]')
          
          # Validate extracted values
          if [ -z "$RESIZE_TIME_UTC" ] || [ -z "$SCHEDULER_TIME_UTC" ] || [ -z "$RESIZE_DATE_UTC" ] || [ -z "$SCHEDULER_DATE_UTC" ]; then
            echo "‚ùå ERROR: Failed to parse Python output"
            echo "Python Output:"
            echo "$PYTHON_OUTPUT"
            exit 1
          fi
          
          echo "resize_time_utc=$RESIZE_TIME_UTC" >> $GITHUB_OUTPUT
          echo "scheduler_time_utc=$SCHEDULER_TIME_UTC" >> $GITHUB_OUTPUT
          echo "resize_date_utc=$RESIZE_DATE_UTC" >> $GITHUB_OUTPUT
          echo "scheduler_date_utc=$SCHEDULER_DATE_UTC" >> $GITHUB_OUTPUT
          echo "resize_time_wib=$RESIZE_TIME_WIB" >> $GITHUB_OUTPUT
          echo "scheduler_time_wib=$SCHEDULER_TIME_WIB" >> $GITHUB_OUTPUT
          
          echo "‚úÖ Calculated Times:"
          echo "   Resize Time: $RESIZE_TIME_WIB WIB ($RESIZE_TIME_UTC UTC) on $RESIZE_DATE_UTC"
          echo "   Scheduler Time: $SCHEDULER_TIME_WIB WIB ($SCHEDULER_TIME_UTC UTC) on $SCHEDULER_DATE_UTC"
        env:
          SCHEDULER_TIME: ${{ steps.quick-check.outputs.scheduler_time }}
          TIMEZONE: ${{ steps.quick-check.outputs.timezone }}
      
      - name: Check if Workflow Should Run
        id: should-run
        if: steps.check-weekend-quick.outputs.is_weekend != 'true'
        run: |
          # Get current time in UTC (GitHub Actions runs in UTC)
          CURRENT_TIME_UTC=$(date -u +"%H:%M")
          CURRENT_DATE_UTC=$(date -u +"%Y-%m-%d")
          CURRENT_DATETIME_UTC=$(date -u +"%Y-%m-%d %H:%M:%S")
          
          # Get calculated times from previous step
          RESIZE_TIME_UTC="${{ steps.quick-calculate.outputs.resize_time_utc }}"
          RESIZE_DATE_UTC="${{ steps.quick-calculate.outputs.resize_date_utc }}"
          SCHEDULER_TIME_UTC="${{ steps.quick-calculate.outputs.scheduler_time_utc }}"
          SCHEDULER_DATE_UTC="${{ steps.quick-calculate.outputs.scheduler_date_utc }}"
          RESIZE_TIME_WIB="${{ steps.quick-calculate.outputs.resize_time_wib }}"
          SCHEDULER_TIME_WIB="${{ steps.quick-calculate.outputs.scheduler_time_wib }}"
          
          # Convert current UTC time to WIB for display (WIB = UTC + 7 hours)
          # Use Python for accurate timezone conversion
          CURRENT_WIB_INFO=$(python3 << 'EOF'
          from datetime import datetime
          import pytz
          
          # Get current UTC time
          utc_now = datetime.now(pytz.UTC)
          
          # Convert to WIB (Asia/Jakarta)
          wib_tz = pytz.timezone('Asia/Jakarta')
          wib_now = utc_now.astimezone(wib_tz)
          
          # Format for display
          current_time_wib = wib_now.strftime("%H:%M")
          current_date_wib = wib_now.strftime("%Y-%m-%d")
          current_datetime_wib = wib_now.strftime("%Y-%m-%d %H:%M:%S")
          
          print(f"CURRENT_TIME_WIB={current_time_wib}")
          print(f"CURRENT_DATE_WIB={current_date_wib}")
          print(f"CURRENT_DATETIME_WIB={current_datetime_wib}")
          EOF
          )
          
          # Extract WIB values
          CURRENT_TIME_WIB=$(echo "$CURRENT_WIB_INFO" | grep "^CURRENT_TIME_WIB=" | cut -d'=' -f2)
          CURRENT_DATE_WIB=$(echo "$CURRENT_WIB_INFO" | grep "^CURRENT_DATE_WIB=" | cut -d'=' -f2)
          CURRENT_DATETIME_WIB=$(echo "$CURRENT_WIB_INFO" | grep "^CURRENT_DATETIME_WIB=" | cut -d'=' -f2)
          
          echo "üîç Window Check:"
          echo "  Current Time: $CURRENT_TIME_WIB WIB ($CURRENT_TIME_UTC UTC) on $CURRENT_DATE_WIB"
          echo "  Resize Time: $RESIZE_TIME_WIB WIB ($RESIZE_TIME_UTC UTC) on $RESIZE_DATE_UTC"
          echo "  Scheduler Time: $SCHEDULER_TIME_WIB WIB ($SCHEDULER_TIME_UTC UTC) on $SCHEDULER_DATE_UTC"
          
          # Convert times to minutes since midnight (UTC) for comparison
          CURRENT_HOUR=$(echo $CURRENT_TIME_UTC | cut -d':' -f1)
          CURRENT_MIN=$(echo $CURRENT_TIME_UTC | cut -d':' -f2)
          CURRENT_MINUTES=$((10#$CURRENT_HOUR * 60 + 10#$CURRENT_MIN))
          
          RESIZE_HOUR=$(echo $RESIZE_TIME_UTC | cut -d':' -f1)
          RESIZE_MIN=$(echo $RESIZE_TIME_UTC | cut -d':' -f2)
          RESIZE_MINUTES=$((10#$RESIZE_HOUR * 60 + 10#$RESIZE_MIN))
          
          SCHEDULER_HOUR=$(echo $SCHEDULER_TIME_UTC | cut -d':' -f1)
          SCHEDULER_MIN=$(echo $SCHEDULER_TIME_UTC | cut -d':' -f2)
          SCHEDULER_MINUTES=$((10#$SCHEDULER_HOUR * 60 + 10#$SCHEDULER_MIN))
          
          # Convert dates to seconds for comparison
          CURRENT_DATE_SEC=$(date -u -d "$CURRENT_DATE_UTC" +%s 2>/dev/null || date -u -j -f "%Y-%m-%d" "$CURRENT_DATE_UTC" +%s 2>/dev/null || echo "0")
          RESIZE_DATE_SEC=$(date -u -d "$RESIZE_DATE_UTC" +%s 2>/dev/null || date -u -j -f "%Y-%m-%d" "$RESIZE_DATE_UTC" +%s 2>/dev/null || echo "0")
          SCHEDULER_DATE_SEC=$(date -u -d "$SCHEDULER_DATE_UTC" +%s 2>/dev/null || date -u -j -f "%Y-%m-%d" "$SCHEDULER_DATE_UTC" +%s 2>/dev/null || echo "0")
          
          SHOULD_RUN=false
          
          # Check if we're on the same day as scheduler
          if [ "$CURRENT_DATE_UTC" = "$SCHEDULER_DATE_UTC" ]; then
            # Same day: check if current time is within resize window (>= resize time AND < scheduler time)
            if [ $CURRENT_MINUTES -ge $RESIZE_MINUTES ] && [ $CURRENT_MINUTES -lt $SCHEDULER_MINUTES ]; then
              SHOULD_RUN=true
              echo "‚úÖ Workflow should RUN: Current time ($CURRENT_TIME_WIB WIB) is within resize window"
              echo "   Window: $RESIZE_TIME_WIB WIB <= Current < $SCHEDULER_TIME_WIB WIB"
            elif [ $CURRENT_MINUTES -lt $RESIZE_MINUTES ]; then
              echo "‚è∏Ô∏è Workflow SKIPPED: Current time ($CURRENT_TIME_WIB WIB) < Resize time ($RESIZE_TIME_WIB WIB)"
              echo "‚è≥ Will wait until $RESIZE_TIME_WIB WIB"
            else
              echo "‚è≠Ô∏è Workflow SKIPPED: Scheduler time already passed"
              echo "   Current: $CURRENT_TIME_WIB WIB, Scheduler: $SCHEDULER_TIME_WIB WIB"
            fi
          elif [ $SCHEDULER_DATE_SEC -gt $CURRENT_DATE_SEC ]; then
            # Scheduler is tomorrow: check if we're past resize time today (for tomorrow's scheduler)
            # This handles edge case where resize time is late at night and scheduler is early next day
            if [ "$CURRENT_DATE_UTC" = "$RESIZE_DATE_UTC" ] && [ $CURRENT_MINUTES -ge $RESIZE_MINUTES ]; then
              SHOULD_RUN=true
              echo "‚úÖ Workflow should RUN: Current time ($CURRENT_TIME_WIB WIB) >= Resize time ($RESIZE_TIME_WIB WIB) for tomorrow's scheduler"
            else
              echo "‚è∏Ô∏è Workflow SKIPPED: Scheduler is tomorrow, waiting for resize window"
              echo "   Resize time: $RESIZE_TIME_WIB WIB on $RESIZE_DATE_UTC"
            fi
          else
            echo "‚è≠Ô∏è Workflow SKIPPED: Scheduler date ($SCHEDULER_DATE_UTC) is in the past"
          fi
          
          echo "should_run=$SHOULD_RUN" >> $GITHUB_OUTPUT
      
      - name: Azure Login
        if: steps.should-run.outputs.should_run == 'true'
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Calculate Resize Time (Final)
        id: calculate-time
        if: steps.should-run.outputs.should_run == 'true'
        run: |
          # Use values from quick-check (already validated and calculated)
          # This step is mainly for logging and consistency
          echo "‚úÖ Using calculated values from previous step:"
          echo "   Scheduler Time: ${{ steps.quick-check.outputs.scheduler_time }} ${{ steps.quick-check.outputs.timezone }}"
          echo "   Resize Time: ${{ steps.quick-calculate.outputs.resize_time_wib }} WIB (${{ steps.quick-calculate.outputs.resize_time_utc }} UTC)"
          echo "   Scheduler Time: ${{ steps.quick-calculate.outputs.scheduler_time_wib }} WIB (${{ steps.quick-calculate.outputs.scheduler_time_utc }} UTC)"
          
          # Copy values from quick-calculate step
          echo "resize_time_utc=${{ steps.quick-calculate.outputs.resize_time_utc }}" >> $GITHUB_OUTPUT
          echo "scheduler_time_utc=${{ steps.quick-calculate.outputs.scheduler_time_utc }}" >> $GITHUB_OUTPUT
          echo "resize_date_utc=${{ steps.quick-calculate.outputs.resize_date_utc }}" >> $GITHUB_OUTPUT
          echo "scheduler_date_utc=${{ steps.quick-calculate.outputs.scheduler_date_utc }}" >> $GITHUB_OUTPUT
          echo "resize_time_wib=${{ steps.quick-calculate.outputs.resize_time_wib }}" >> $GITHUB_OUTPUT
          echo "scheduler_time_wib=${{ steps.quick-calculate.outputs.scheduler_time_wib }}" >> $GITHUB_OUTPUT
      
      - name: Check Current Time and Container Size
        if: steps.should-run.outputs.should_run == 'true'
        id: check-current
        run: |
          CURRENT_TIME_UTC=$(date -u +"%H:%M")
          CURRENT_DATE_UTC=$(date -u +"%Y-%m-%d")
          echo "current_time_utc=$CURRENT_TIME_UTC" >> $GITHUB_OUTPUT
          echo "current_date_utc=$CURRENT_DATE_UTC" >> $GITHUB_OUTPUT
          
          # Get current container size
          CURRENT_CPU=$(az containerapp show \
            --name $CONTAINER_APP_NAME \
            --resource-group $RESOURCE_GROUP \
            --query "properties.template.containers[0].resources.cpu" \
            -o tsv 2>/dev/null || echo "0.25")
          echo "current_cpu=$CURRENT_CPU" >> $GITHUB_OUTPUT
          
          echo "üïê Current Time (UTC): $CURRENT_TIME_UTC"
          echo "üíª Current CPU: $CURRENT_CPU"
      
      - name: Determine if Resize Needed
        if: steps.should-run.outputs.should_run == 'true'
        id: should-resize
        run: |
          CURRENT_CPU="${{ steps.check-current.outputs.current_cpu }}"
          
          # Workflow sudah di-check di "Check if Workflow Should Run"
          # Jika sampai sini, berarti kondisi sudah terpenuhi (current time >= resize time AND < scheduler time)
          # Tinggal check apakah container sudah besar atau belum
          
          if [ "$CURRENT_CPU" != "4" ]; then
            echo "resize_needed=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Resize needed: Container is small, will resize to 4 vCPU/8GB"
          else
            echo "resize_needed=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è Container already large (CPU: $CURRENT_CPU)"
          fi
      
      - name: Resize Container to Large
        if: steps.should-resize.outputs.resize_needed == 'true'
        run: |
          echo "üöÄ Resizing container to 4 vCPU / 8GB..."
          az containerapp update \
            --name $CONTAINER_APP_NAME \
            --resource-group $RESOURCE_GROUP \
            --cpu 4 \
            --memory 8Gi
          
          echo "‚úÖ Container resized successfully to 4 vCPU / 8GB"

