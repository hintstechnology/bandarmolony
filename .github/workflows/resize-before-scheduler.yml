name: Resize Container Before Scheduler

on:
  # Real-time: triggered via webhook when scheduler time changes
  repository_dispatch:
    types: [scheduler-time-changed]
  # Fallback: polling every 5 minutes
  schedule:
    - cron: '*/5 * * * *'
  # Manual trigger
  workflow_dispatch:

env:
  API_URL: ${{ secrets.VITE_API_URL }}
  CONTAINER_APP_NAME: ${{ secrets.BE_CONTAINER_APP_NAME }}
  RESOURCE_GROUP: ${{ secrets.RESOURCE_GROUP }}

jobs:
  resize-before-scheduler:
    runs-on: ubuntu-latest
    
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Get Scheduler Config
        id: get-config
        run: |
          echo "üîç Event Type: ${{ github.event_name }}"
          echo "üîç Event Action: ${{ github.event.action }}"
          
          # If triggered via webhook, use payload
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "‚úÖ Triggered via repository_dispatch webhook"
            echo "üìã Event Type: ${{ github.event.action }}"
            SCHEDULER_TIME="${{ github.event.client_payload.new_time }}"
            TIMEZONE="${{ github.event.client_payload.timezone }}"
            WEEKEND_SKIP="${{ github.event.client_payload.weekend_skip }}"
            echo "üì• Using webhook payload: $SCHEDULER_TIME ($TIMEZONE)"
          else
            # If polling, fetch from API
            echo "üì° Triggered via schedule/polling"
            RESPONSE=$(curl -s "$API_URL/api/public/scheduler/config")
            SCHEDULER_TIME=$(echo $RESPONSE | jq -r '.data.config.PHASE1_DATA_COLLECTION_TIME')
            TIMEZONE=$(echo $RESPONSE | jq -r '.data.config.TIMEZONE')
            WEEKEND_SKIP=$(echo $RESPONSE | jq -r '.data.config.WEEKEND_SKIP')
            echo "üì° Fetched from API: $SCHEDULER_TIME ($TIMEZONE)"
          fi
          
          echo "scheduler_time=$SCHEDULER_TIME" >> $GITHUB_OUTPUT
          echo "timezone=$TIMEZONE" >> $GITHUB_OUTPUT
          echo "weekend_skip=$WEEKEND_SKIP" >> $GITHUB_OUTPUT
      
      - name: Check if Weekend (if WEEKEND_SKIP enabled)
        id: check-weekend
        if: steps.get-config.outputs.weekend_skip == 'true'
        run: |
          # Check if today is weekend (Saturday=6, Sunday=0)
          DAY_OF_WEEK=$(date -u +%w)
          if [ "$DAY_OF_WEEK" = "0" ] || [ "$DAY_OF_WEEK" = "6" ]; then
            echo "is_weekend=true" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è Weekend detected - skipping resize"
          else
            echo "is_weekend=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Calculate Resize Time
        id: calculate-time
        if: steps.check-weekend.outputs.is_weekend != 'true'
        run: |
          SCHEDULER_TIME="${{ steps.get-config.outputs.scheduler_time }}"
          TIMEZONE="${{ steps.get-config.outputs.timezone }}"
          
          # Use Python for timezone conversion
          PYTHON_OUTPUT=$(python3 << 'EOF'
          from datetime import datetime, timedelta
          import pytz
          import os
          import sys
          
          scheduler_time_str = os.environ.get('SCHEDULER_TIME', '19:00')
          timezone_str = os.environ.get('TIMEZONE', 'Asia/Jakarta')
          
          # Parse time
          hour, minute = map(int, scheduler_time_str.split(':'))
          
          # Get timezone
          tz = pytz.timezone(timezone_str)
          utc = pytz.UTC
          
          # Get today's date in that timezone
          now_tz = datetime.now(tz)
          scheduler_dt = tz.localize(datetime(now_tz.year, now_tz.month, now_tz.day, hour, minute))
          
          # Subtract 5 minutes
          resize_dt = scheduler_dt - timedelta(minutes=5)
          
          # Convert to UTC
          resize_utc = resize_dt.astimezone(utc)
          scheduler_utc = scheduler_dt.astimezone(utc)
          
          # Format for comparison
          resize_time_utc = resize_utc.strftime("%H:%M")
          scheduler_time_utc = scheduler_utc.strftime("%H:%M")
          resize_date_utc = resize_utc.strftime("%Y-%m-%d")
          scheduler_date_utc = scheduler_utc.strftime("%Y-%m-%d")
          
          print(f"RESIZE_TIME_UTC={resize_time_utc}")
          print(f"SCHEDULER_TIME_UTC={scheduler_time_utc}")
          print(f"RESIZE_DATE_UTC={resize_date_utc}")
          print(f"SCHEDULER_DATE_UTC={scheduler_date_utc}")
          EOF
          )
          
          # Parse Python output and set GitHub outputs
          echo "üìã Python Output:"
          echo "$PYTHON_OUTPUT"
          
          # Extract values from Python output (handle both stdout and stderr)
          RESIZE_TIME_UTC=$(echo "$PYTHON_OUTPUT" | grep "^RESIZE_TIME_UTC=" | head -1 | cut -d'=' -f2 | tr -d '[:space:]')
          SCHEDULER_TIME_UTC=$(echo "$PYTHON_OUTPUT" | grep "^SCHEDULER_TIME_UTC=" | head -1 | cut -d'=' -f2 | tr -d '[:space:]')
          RESIZE_DATE_UTC=$(echo "$PYTHON_OUTPUT" | grep "^RESIZE_DATE_UTC=" | head -1 | cut -d'=' -f2 | tr -d '[:space:]')
          SCHEDULER_DATE_UTC=$(echo "$PYTHON_OUTPUT" | grep "^SCHEDULER_DATE_UTC=" | head -1 | cut -d'=' -f2 | tr -d '[:space:]')
          
          # Validate extracted values
          if [ -z "$RESIZE_TIME_UTC" ] || [ -z "$SCHEDULER_TIME_UTC" ] || [ -z "$RESIZE_DATE_UTC" ] || [ -z "$SCHEDULER_DATE_UTC" ]; then
            echo "‚ùå Error: Failed to parse Python output"
            echo "RESIZE_TIME_UTC: '$RESIZE_TIME_UTC'"
            echo "SCHEDULER_TIME_UTC: '$SCHEDULER_TIME_UTC'"
            echo "RESIZE_DATE_UTC: '$RESIZE_DATE_UTC'"
            echo "SCHEDULER_DATE_UTC: '$SCHEDULER_DATE_UTC'"
            exit 1
          fi
          
          # Set GitHub outputs
          echo "resize_time_utc=$RESIZE_TIME_UTC" >> $GITHUB_OUTPUT
          echo "scheduler_time_utc=$SCHEDULER_TIME_UTC" >> $GITHUB_OUTPUT
          echo "resize_date_utc=$RESIZE_DATE_UTC" >> $GITHUB_OUTPUT
          echo "scheduler_date_utc=$SCHEDULER_DATE_UTC" >> $GITHUB_OUTPUT
          
          echo "‚úÖ Parsed Values:"
          echo "  üìÖ Resize Time (UTC): $RESIZE_TIME_UTC on $RESIZE_DATE_UTC"
          echo "  üìÖ Scheduler Time (UTC): $SCHEDULER_TIME_UTC on $SCHEDULER_DATE_UTC"
        env:
          SCHEDULER_TIME: ${{ steps.get-config.outputs.scheduler_time }}
          TIMEZONE: ${{ steps.get-config.outputs.timezone }}
      
      - name: Check Current Time and Container Size
        id: check-current
        run: |
          CURRENT_TIME_UTC=$(date -u +"%H:%M")
          CURRENT_DATE_UTC=$(date -u +"%Y-%m-%d")
          echo "current_time_utc=$CURRENT_TIME_UTC" >> $GITHUB_OUTPUT
          echo "current_date_utc=$CURRENT_DATE_UTC" >> $GITHUB_OUTPUT
          
          # Get current container size
          CURRENT_CPU=$(az containerapp show \
            --name $CONTAINER_APP_NAME \
            --resource-group $RESOURCE_GROUP \
            --query "properties.template.containers[0].resources.cpu" \
            -o tsv 2>/dev/null || echo "0.25")
          echo "current_cpu=$CURRENT_CPU" >> $GITHUB_OUTPUT
          
          echo "üïê Current Time (UTC): $CURRENT_TIME_UTC"
          echo "üíª Current CPU: $CURRENT_CPU"
      
      - name: Determine if Resize Needed
        id: should-resize
        if: steps.check-weekend.outputs.is_weekend != 'true' && steps.calculate-time.outcome == 'success'
        run: |
          CURRENT_TIME="${{ steps.check-current.outputs.current_time_utc }}"
          CURRENT_DATE="${{ steps.check-current.outputs.current_date_utc }}"
          RESIZE_TIME="${{ steps.calculate-time.outputs.resize_time_utc }}"
          RESIZE_DATE="${{ steps.calculate-time.outputs.resize_date_utc }}"
          SCHEDULER_TIME_UTC="${{ steps.calculate-time.outputs.scheduler_time_utc }}"
          SCHEDULER_DATE="${{ steps.calculate-time.outputs.scheduler_date_utc }}"
          CURRENT_CPU="${{ steps.check-current.outputs.current_cpu }}"
          
          echo "üîç Debug Info:"
          echo "  Current Time (UTC): $CURRENT_TIME"
          echo "  Current Date (UTC): $CURRENT_DATE"
          echo "  Resize Time (UTC): $RESIZE_TIME"
          echo "  Resize Date (UTC): $RESIZE_DATE"
          echo "  Scheduler Time (UTC): $SCHEDULER_TIME_UTC"
          echo "  Scheduler Date (UTC): $SCHEDULER_DATE"
          echo "  Current CPU: $CURRENT_CPU"
          
          # Check if dates match
          if [ -z "$RESIZE_DATE" ] || [ -z "$SCHEDULER_DATE" ] || [ -z "$RESIZE_TIME" ] || [ -z "$SCHEDULER_TIME_UTC" ]; then
            echo "resize_needed=false" >> $GITHUB_OUTPUT
            echo "‚ùå Error: Missing required values (Resize Date: '$RESIZE_DATE', Scheduler Date: '$SCHEDULER_DATE', Resize Time: '$RESIZE_TIME', Scheduler Time: '$SCHEDULER_TIME_UTC')"
            exit 0
          fi
          
          # Check if current time is within resize window
          # Resize window: [RESIZE_TIME, SCHEDULER_TIME_UTC) on the same day
          if [ "$CURRENT_DATE" = "$RESIZE_DATE" ] && [ "$CURRENT_DATE" = "$SCHEDULER_DATE" ]; then
            # Compare times (HH:MM format)
            CURRENT_MINUTES=$((10#$(echo $CURRENT_TIME | cut -d':' -f1) * 60 + 10#$(echo $CURRENT_TIME | cut -d':' -f2)))
            RESIZE_MINUTES=$((10#$(echo $RESIZE_TIME | cut -d':' -f1) * 60 + 10#$(echo $RESIZE_TIME | cut -d':' -f2)))
            SCHEDULER_MINUTES=$((10#$(echo $SCHEDULER_TIME_UTC | cut -d':' -f1) * 60 + 10#$(echo $SCHEDULER_TIME_UTC | cut -d':' -f2)))
            
            if [ $CURRENT_MINUTES -ge $RESIZE_MINUTES ] && [ $CURRENT_MINUTES -lt $SCHEDULER_MINUTES ]; then
              if [ "$CURRENT_CPU" != "4" ]; then
                echo "resize_needed=true" >> $GITHUB_OUTPUT
                echo "‚úÖ Resize needed: Current time is in resize window and container is small"
              else
                echo "resize_needed=false" >> $GITHUB_OUTPUT
                echo "‚è≠Ô∏è Container already large"
              fi
            else
              echo "resize_needed=false" >> $GITHUB_OUTPUT
              echo "‚è≠Ô∏è Not in resize window (Current: $CURRENT_TIME [$CURRENT_MINUTES min], Window: $RESIZE_TIME [$RESIZE_MINUTES min] - $SCHEDULER_TIME_UTC [$SCHEDULER_MINUTES min])"
            fi
          else
            echo "resize_needed=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è Date mismatch (Current: $CURRENT_DATE, Resize: $RESIZE_DATE, Scheduler: $SCHEDULER_DATE)"
          fi
      
      - name: Resize Container to Large
        if: steps.should-resize.outputs.resize_needed == 'true'
        run: |
          echo "üöÄ Resizing container to 4 vCPU / 8GB..."
          az containerapp update \
            --name $CONTAINER_APP_NAME \
            --resource-group $RESOURCE_GROUP \
            --cpu 4 \
            --memory 8Gi
          
          echo "‚úÖ Container resized successfully to 4 vCPU / 8GB"

